# CloudTrail 設定手順書

## 第1章 前提・目的・全体構成

### 1.1 前提条件

本手順書は、医療情報を取り扱うシステムにおいて、AWS 環境上の操作履歴およびアクセス状況を記録・保管することを目的として CloudTrail を設定するための手順を示すものである。

本システムの前提条件は以下のとおりとする。

* インターネット経由で AWS を利用する構成であること
* Amazon S3 に医療情報を含むバックアップデータを保存すること
* API Gateway + Lambda により Presigned URL を発行する構成であること
* TLS 1.3 + mTLS を採用し、証明書は ACM Private CA により発行すること

---

### 1.2 目的

本手順書の目的は以下のとおりである。

* AWS 上で実行される操作を網羅的に記録すること
* 医療情報ガイドライン（2024）におけるアクセス記録要件を満たすこと
* 監査時に操作履歴を説明可能な状態を構築すること

---

### 1.3 対象範囲

本手順書は、以下の AWS サービスを対象とする。

* AWS CloudTrail
* Amazon S3（ログ保存用バケット、バックアップデータ用バケット）
* IAM
* API Gateway
* AWS Lambda
* ACM / ACM Private CA

---

## 第2章 CloudTrail 全体設計概要

### 2.1 設計方針

* CloudTrail は全リージョンで有効化する
* 管理イベントは Read / Write を含めすべて記録する
* 医療情報に関連する S3 バケットについてはデータイベントを有効化する
* ログは専用 S3 バケットに保存し、改ざん防止対策を講じる

---

## 第3章 事前準備

### 3.1 IAM 権限の確認

CloudTrail を設定する作業者は、以下の権限を有していることを確認する。

* CloudTrail 管理権限
* S3 バケット作成・設定権限
* IAM ロールおよびポリシー閲覧権限

---

### 3.2 ログ保存用 S3 バケットの設計

* CloudTrail 専用の S3 バケットを新規に作成する
* バックアップデータ用バケットとは分離する
* パブリックアクセスはすべてブロックする

---

## 第4章 CloudTrail 設定手順

### 4.1 CloudTrail の作成

1. AWS マネジメントコンソールにログインする
2. CloudTrail サービスを開く
3. 「証跡の作成」を選択する
4. 以下の内容を設定する
   * 証跡名：任意（例：medical-system-cloudtrail）
   * 全リージョンに適用：有効
   * 管理イベント：すべて記録

---

### 4.2 管理イベントの設定

* 読み取りイベント：有効
* 書き込みイベント：有効
* 除外設定：なし

これにより、IAM、S3、API Gateway、Lambda、ACM Private CA に関する操作が記録される。

---

### 4.3 データイベント（S3）の設定

1. データイベント設定画面を開く
2. S3 データイベントを有効化する
3. 対象バケットとして、バックアップデータ格納用バケットを指定する
4. 記録対象操作を以下とする
   * PutObject
   * GetObject
   * DeleteObject

---

### 4.4 ログ保存先の指定

* 事前に作成した CloudTrail 専用 S3 バケットを指定する
* サーバーサイド暗号化を有効化する

---

### 4.5 ログファイル整合性検証の有効化

* CloudTrail 設定画面にて「ログファイルの整合性検証」を有効にする
* ログの改ざん検知を可能とする

---

## 第5章 S3 バケットセキュリティ設定

### 5.1 バケットポリシー設定

* CloudTrail サービスからの書き込みのみを許可する
* 他の IAM ユーザーからの書き込みは禁止する

---

### 5.2 パブリックアクセスブロック

* すべてのパブリックアクセスをブロックする

---

## 第6章 運用・確認

### 6.1 動作確認

* CloudTrail にイベントが記録されていることを確認する
* S3 バケットにログファイルが生成されていることを確認する

---

### 6.2 運用上の注意点

* CloudTrail を停止・削除しないこと
* 設定変更時は必ず変更履歴を確認すること
* 監査対応時は CloudTrail ログを正式な証跡として使用する

---

## 第7章 証明書基盤（ACM Private CA）との関係

* ACM Private CA の作成・設定変更・証明書発行操作は CloudTrail に記録される
* mTLS 用クライアント証明書の運用に関する操作履歴も追跡可能である

---

## 第8章 まとめ

本手順により、AWS 上の操作履歴および医療情報へのアクセス状況を適切に記録し、
医療情報ガイドラインに準拠した監査対応が可能な構成を実現する。
