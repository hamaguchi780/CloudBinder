# 第1章：S3 バケット運用手順（Runbook）

本章では、クラウドバインダー（S3）プロジェクトにおける **S3 バケットの運用手順** を定義する。
本システムでは、S3 バケットは CloudFormation 管理外とし、**運用手順により厳密に統制** する。

---

## 1.1 運用方針（前提）

* S3 バケットは **クライアント（端末）単位で 1 バケット** とする
* バケット名は **クライアント証明書の CN と 1 対 1 に対応** する
* バケット作成・削除は **オンボーディング／オフボーディング作業の一部** として実施する
* Lambda は CN からバケット名を自動解決するため、
  **命名規則の逸脱は即時障害につながる**

---

## 1.2 バケット命名規則

### 命名フォーマット

```text
binder-<env>-<CN>
```

| 要素 | 説明 | 例 |
|---|---|---|
| `binder` | 固定プレフィックス | `binder` |
| `<env>` | 環境識別子 | `prod` / `stg` / `dev` |
| `<CN>` | クライアント証明書の CN | `client001` |

### 具体例

```text
binder-prod-client001
```

⚠️ **注意**

* CN に大文字・記号を含めないこと
* 証明書 CN と S3 バケット名は完全一致させること

---

## 1.3 バケット作成手順（オンボーディング）

### 手順概要

1. クライアント証明書（CN）を確定
2. 命名規則に従い S3 バケットを作成
3. セキュリティ設定を適用
4. 動作確認

---

### 1.3.1 バケット作成

* AWS マネジメントコンソール または AWS CLI を使用
* 対象リージョンは **システム標準リージョン** に限定

---

### 1.3.2 パブリックアクセスの遮断

以下を **すべて有効化** すること：

* パブリックアクセスをすべてブロック
  * 新しいパブリック ACL をブロック
  * パブリック ACL を無視
  * 新しいパブリックポリシーをブロック
  * パブリックポリシーをブロック

---

### 1.3.3 暗号化設定

* **SSE-S3（AES-256）を必須** とする
* クライアントバックアップ用途の S3 バケットでは **SSE-KMS は使用しない**

#### 採用理由（設計判断）

本システムでは、保存データの性質と運用特性に応じて暗号化方式を使い分ける。

* クライアントバックアップデータは以下の特性を持つ：
  * 大容量・高頻度の書き込み
  * バケット数がクライアント数に比例して増加
  * Presigned URL による限定的アクセスのみ

これらを踏まえ、以下を優先する：

* 鍵管理・運用負荷の最小化
* バケット追加時の作業簡素化
* KMS スロットリングやコスト影響の回避

そのため、クライアント用 S3 バケットでは
**AWS 管理鍵による SSE-S3（AES-256）を正式採用**とする。

#### 補足（他サービスとの切り分け）

* CloudTrail / AWS Config / CloudWatch Logs などの
  **制御・監査・証跡用途の S3 バケットおよび関連リソース**では、
  **SSE-KMS（CMK）を使用する**
* 本章の対象はあくまで「クライアントバックアップデータ用 S3 バケット」であり、
  他用途の暗号化方針とは切り分けて管理する
  
---

### 1.3.4 バージョニング

* **有効化する**

理由：

* 誤削除・上書き対策
* ランサムウェア対策の基礎

---

### 1.3.5 ライフサイクル（任意）

必要に応じて以下を検討する：

* 非最新バージョンの削除
* Glacier への移行

※ 初期構築時は **設定しない** 方針とする

---

## 1.4 アクセス制御

### 基本方針

* クライアントは **Presigned URL 経由のみ** で S3 にアクセス
* IAM ユーザー／ロールの直接付与は禁止

### IAM ポリシー管理

* Lambda 実行ロールの IAM ポリシーは CloudFormation 管理
* S3 バケット側での個別ポリシー追加は原則禁止

---

## 1.5 運用時の注意点

### 1.5.1 証明書失効との関係

* クライアント証明書を失効しても **S3 バケットは自動削除されない**
* 失効後は以下を実施する：
  * 当該 CN の Presigned URL が発行されないことを確認
  * バケットを「利用停止状態」として扱う

---

### 1.5.2 クライアント再発行時

* 同一 CN を再利用する場合：
  * **既存バケットを継続使用**
* CN を変更する場合：
  * 新バケット作成
  * 旧バケットは移行後に廃止

---

## 1.6 バケット廃止手順（オフボーディング）

### 廃止判断

以下の条件をすべて満たすこと：

* 証明書が失効済み
* バックアップデータ保持期間が満了
* 利害関係者の承認取得

---

### 廃止手順

1. バケット内容の最終確認
2. 必要に応じてアーカイブ取得
3. **バージョンを含めて完全削除**
4. 削除ログを記録

⚠️ **注意**

* バージョニング有効時は、通常削除ではオブジェクトが残存するため要注意

---

## 1.7 監査・ログ

* S3 アクセスログは CloudTrail 管理イベントで追跡
* 必要に応じてデータイベントを有効化

---
