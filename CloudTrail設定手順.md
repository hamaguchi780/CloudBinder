# CloudTrail 設定手順書

## 第1章 前提・目的・全体構成

### 1.1 前提条件

本手順書は、医療情報を取り扱うシステムにおいて、AWS 環境上の操作履歴およびアクセス状況を記録・保管することを目的として CloudTrail を設定するための手順を示すものである。

本システムの前提条件は以下のとおりとする。

* インターネット経由で AWS を利用する構成であること
* Amazon S3 に医療情報を含むバックアップデータを保存すること
* API Gateway + Lambda により Presigned URL を発行する構成であること
* TLS 1.3 + mTLS を採用し、証明書は ACM Private CA により発行すること

---

### 1.2 目的

本手順書の目的は以下のとおりである。

* AWS 上で実行される操作を網羅的に記録すること
* 医療情報ガイドライン（2024）におけるアクセス記録要件を満たすこと
* 監査時に操作履歴を説明可能な状態を構築すること

---

### 1.3 対象範囲

本手順書は、以下の AWS サービスを対象とする。

* AWS CloudTrail
* Amazon S3（ログ保存用バケット、バックアップデータ用バケット）
* IAM
* API Gateway
* AWS Lambda
* ACM / ACM Private CA

---

## 第2章 CloudTrail 全体設計概要

### 2.1 設計方針

* CloudTrail は全リージョンで有効化する
* 管理イベントは Read / Write を含めすべて記録する
* 医療情報に関連する S3 バケットについてはデータイベントを有効化する
* ログは専用 S3 バケットに保存し、改ざん防止対策を講じる

---

## 第3章 事前準備

### 3.1 IAM 権限の確認

CloudTrail を設定する作業者は、以下の権限を有していることを確認する。

* CloudTrail 管理権限
* S3 バケット作成・設定権限
* IAM ロールおよびポリシー閲覧権限

---

### 3.2 ログ保存用 S3 バケットの設計

* CloudTrail 専用の S3 バケットを新規に作成する
* バックアップデータ用バケットとは分離する
* パブリックアクセスはすべてブロックする

---

## 第4章 CloudTrail 設定手順

### 4.1 CloudTrail の作成（AWS マネジメントコンソール）

1. AWS マネジメントコンソールに管理者権限を持つ IAM ユーザーでログインする
2. サービス一覧から「CloudTrail」を選択する
3. 左メニューより「証跡」を選択する
4. 「証跡の作成」ボタンをクリックする
5. 以下の項目を設定する

#### 基本設定

* 証跡名：任意（例：medical-system-trail）
* ストレージの場所：新しい S3 バケットを作成
* S3 バケット名：任意（例：medical-system-cloudtrail-logs）

#### 証跡の適用範囲

* このアカウント内のすべてのリージョンに適用：有効（チェックを入れる）

#### 管理イベント

* 管理イベントの記録：有効
* API アクティビティ：読み取り / 書き込み 両方を選択

設定内容を確認し、「次へ」をクリックする

---

### 4.2 管理イベントの詳細設定

1. 管理イベント設定画面にて以下を確認する

* 読み取りイベント：有効
* 書き込みイベント：有効
* 除外対象のサービス・リソース：設定しない

1. 対象となる主なサービスは以下を含む

* IAM
* Amazon S3
* Amazon API Gateway
* AWS Lambda
* AWS Certificate Manager
* ACM Private CA
* CloudTrail

1. 設定内容を確認し、「次へ」をクリックする

---

### 4.3 データイベント（S3）の設定

1. データイベント設定画面にて「データイベントを有効にする」を選択する
2. データイベントタイプとして「S3」を選択する
3. リソースタイプで「特定の S3 バケット」を選択する
4. バックアップデータ格納用 S3 バケットを指定する
5. 記録対象のイベントタイプとして以下を選択する

* 読み取りイベント（GetObject）
* 書き込みイベント（PutObject / DeleteObject）

1. すべてのオブジェクトに適用する設定とする
2. 設定内容を確認し、「次へ」をクリックする

---

### 4.4 ログ保存先および暗号化設定

1. ログ保存先として CloudTrail 専用 S3 バケットを指定する
2. ログファイルの暗号化設定を以下のとおりとする

* サーバーサイド暗号化：有効
* 暗号化方式：SSE-S3 または SSE-KMS（組織ポリシーに従う）

1. S3 バケットのパブリックアクセスブロック設定が有効であることを確認する

---

### 4.5 ログファイル整合性検証の有効化

1. CloudTrail 証跡作成画面にて「ログファイルの整合性検証」を有効にする
2. この設定により、ログファイルが改ざんされていないことを後から検証可能となる
3. 設定を確認し、「証跡の作成」をクリックする

---

## 第5章 S3 バケットセキュリティ設定

### 5.1 バケットポリシー設定

* CloudTrail サービスからの書き込みのみを許可する
* 他の IAM ユーザーからの書き込みは禁止する

---

### 5.2 パブリックアクセスブロック

* すべてのパブリックアクセスをブロックする

---

## 第6章 運用・確認

### 6.1 動作確認

* CloudTrail にイベントが記録されていることを確認する
* S3 バケットにログファイルが生成されていることを確認する

---

### 6.2 運用上の注意点

* CloudTrail を停止・削除しないこと
* 設定変更時は必ず変更履歴を確認すること
* 監査対応時は CloudTrail ログを正式な証跡として使用する

---

## 第7章 証明書基盤（ACM Private CA）との関係

* ACM Private CA の作成・設定変更・証明書発行操作は CloudTrail に記録される
* mTLS 用クライアント証明書の運用に関する操作履歴も追跡可能である

---

## 第8章 まとめ

本手順により、AWS 上の操作履歴および医療情報へのアクセス状況を適切に記録し、
医療情報ガイドラインに準拠した監査対応が可能な構成を実現する。
